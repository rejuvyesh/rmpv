#!/usr/bin/env ruby
# -*- encoding: utf-8 -*-
# Copyright rejuvyesh <mail@rejuvyesh.com>, 2013

require "shellwords"
require "to_name"
require "rmpv"

# check if there is a .mp file in the current directory and add it as options
if File.exists? ".mp"
  File.open(".mp", "r").each do |line|
    ARGV << line.chomp
  end
end

# parse options
cmd, options = Rmpv::Option.parse(ARGV)
cmd = Rmpv::Option.command(cmd, options)

# begin execution
file = Shellwords.shelljoin(ARGV)
mpv = cmd.join(" ") + " " + file
puts "running '#{mpv}'..."

# set as watching
if options[:method].casecmp('trakt').zero?
  show = ToName.to_name(file)
  @trak = Rmpv::Trakt.new
  progress = 0
  time = 0
  wat = Thread.new do
    loop do
      duration = @trak.watching(show, progress)
      sleep(600) # wait for 10 minutes
      time += 10
      progress = time*100/duration
    end
  end
end

system mpv

Thread.kill(wat)

# mark as seen on trakt
if options[:method].casecmp('trakt').zero?
  show = ToName.to_name(file)
  @trak = Rmpv::Trakt.new
  if progress>=85
    @trak.scrobble(show)
  end
end
